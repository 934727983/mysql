# 这一篇没有英文 {#concept_bsg_zcw_ydb .concept}

## Use Scenarios {#section_ntt_5dw_ydb .section}

The RDS for SQL Server version 2012/2016 provides incremental cloud-on-the-go functionality, the control of the business interrupt time during the cloud is at the minute level, which greatly reduces the business interrupt time. 6\) RDS for SQL The cloud on the server incremental data applies to the following scenarios:

-   Physically migrate to an RDS for SQL Server Based on a backup file, rather than a logical migration.

**Note:** 

-   Physical migration refers to file-based migration, logical migration means writing data generation DML statements to the RDS for SQL Server\)

-   Physical migration can be consistent with a database post-migration and a local environment of 100. Logical migration cannot be 100% consistent, such as index fragmentation rates and statistics.

-   If you are sensitive to business stop times and need to control at the minute level, it is recommended to select incremental migration.

**Note:** 

If you are not sensitive to business stop times \(such as 2 hours \), we recommend that you use it directly when the database is less than 100g.


This document is intended to show you how to use a full backup file that is based on the user OSS space plus a log backup \(or differential backup files \), implements an incremental migration of the SQL Server database to the RDS for SQL Server under the user line.

## Example of Operation Process {#section_psh_d2w_ydb .section}

![](images/4342_en-US.png)

[\(Click to get a full view\)](./images/4342_en-US.png)

Based on the incremental cloud case above, according to the time dimension, the explanation is as follows:

|On-cloud phase|Steps|Description|
|--------------|-----|-----------|
|Total phase|Step 1: Before 3: 00|Completion of preparatory work, including:-   Complete DBCC checkdb check;
-   To shut down the local environment backup system;
-   Modify the database to full recovery mode.

|
|Step. 00:01|The user starts to do full backup on the offline database.|
|Stepp. 02:00|Complete full backup, which takes nearly 1 hour to upload backup files to the OSS bucket.|
|Step 4: 03/2016 00|After completing the backup file upload, it takes 1 hour to start restoring the full backup file on the RDS console.|
|Step5. 22:00|Complete full backup to recover the cloud, 19 hours to begin the database incremental log backup cloud-on-site process.|
|Incremental phase|Step6. 22:20|It takes 20 minutes to complete the log backup and upload to OSS, start restoring incremental log files in the RDS console.|
|Step7. 22:30| -   It takes 10 minutes to complete the cloud on log backup.
-   Repeat step6-7, continue to backup log, upload to OSS, incremental cloud log backup files, make sure that the last backup log file is as small as possible \(less than 500 mb \).
-   **Stop local application writing to the database and make a log backup for the last incremental on the cloud.**

 |
|Open Database|Step8. 22:34|Finished the last log backup file incremental cloud operation, which took 4 minutes, begin to bring the database online.|
|Step9. 22:35|The database is up and running, if you choose to perform the DBCC operation asynchronously, is fast and takes 1 minute.|

**From the entire action flow and timeline, the user needs to stop the application for a very short time, stop writing only before the last log backup.** In this case, the time control for the entire application to stop is within 5 minutes.

## Prerequisite {#section_bdr_f2w_ydb .section}

-   **RDS for SQL Server currently supports the following versions:**

    -   RDS for SQL Server 2012/2016 web edition, 2012 enterprise stand-alone Foundation edition.
    -   RDS for SQL Server 2012/2016 Standard Edition, Enterprise Edition High Availability series \(that is, dual machine edition \).
-   **To authorize an RDS service account to access OSS Permissions**

    After you have granted the RDS service account access rights to OSS, the system creates a role named maid in the role management of the access control Ram. Do not modify or delete this role, otherwise you will not be able to download the backup files when you are on the cloud. If you modify or delete this role, you need to re-authorize it through the cloud wizard on the data.

-   **Prepare the OSS bucket.**

    Create the OSS bucket in the same area as the target instance. Skip this step if the bucket already exists. Create a method refer to creating a storage space

-   **Make sure that the database recovery mode is full**

    When the Incremental backup data is on the cloud, the recovery mode for the user database must be full mode. A transaction log backup is not permitted when the recovery mode is simple, differential backup files are likely to be large, resulting in incremental cloud-on-cloud time being stretched.

-   **RDS for SQL Server spatial requirements**

    Make sure that the RDS for SQL Server has enough storage space, if you do not have enough space, upgrade the instance space in advance to avoid migration failure due to insufficient space.

-   **Target database with the same name cannot exist in the RDS for SQL Server**

    If a database with the same name already exists, first back up the database and delete the database, create the migration task again.

-   **Creating an initial account on the RDS for SQL Server**

    Create the initial account for the target instance through the RDS console, and if the initial account already exists, please skip this step.

-   **Turn off the local backup system**

    To ensure incremental cloud success, shut down the backup system for the local environment. Otherwise, because of an automated backup operation on a cloud database by a backup system in a local environment, causes the incremental cloud to fail.

-   **Running DBCC checkdb**

    Do a DBCC checkdb \('xxx '\) check on the database that needs to be on the cloud in the local environment, after execution, make sure that there are no allocation errors and consistency Errors. If it is a success, the result as below will be shown:

    ```
     Checkdb found 0 allocation errors and 0 consistency errors in database 'xxx '.
      DBCC execution completed. If DBCC printed error messages, contact your system administrator.
    ```

    If you find any errors with DBCC checkdb, first fix the database in the local environment, otherwise it will cause the cloud to fail.


## Restrictions {#section_pdf_l2w_ydb .section}

-   **Backup file version**

    Migrating from a higher version of the backup file to a lower version is not supported, such: migrate from SQL Server 2016 to RDS for SQL Server 2012, and more.

-   **Name limit after backing up Files**

    Backup file names are only supported for Nak, diff, TRN, or log names. If you do not use the script in this article to generate a backup file, use the following subsequent name:

    -   Bak: represents a full backup file
    -   DIFF: indicates a differential backup file
    -   TRN or log: indicates a transaction log backup
-   **Backup File naming restrictions**

    The database backup file name cannot contain special characters such as Chinese, @, or |, or the directory in the OSS bucket contains Chinese, which causes the cloud task on the OSS backup data recovery to fail.


## Demo {#section_mwg_5fw_ydb .section}

## Operation Steps {#section_c1v_dgw_ydb .section}

**Backing up a local database**

**Note:** Before making a full backup of the local database, make sure that the backup system for the local environment is down.

You can make full backups as known, or use the following method to back up a database:

1.  Download the backup script and open the backup script with SSMs.
2.  Depending on the actual situation, modify the following four parameters:

    |Configuration items|Description|
    |-------------------|-----------|
    |@ Maid|Databases that need to be backed up, separated by a semicolon or comma.|
    |@ Backupr type|Backup Type. The parameter values are as follows:    -   Full: Full backup;
    -   DIFF: Differential backup;
    -   Log: log backup.
|
    |@ Backupr folder|The local directory where the backup files reside. If it does not exist, it is automatically created.|
    |@ Is\_run|Whether to perform a backup. The parameter values are as follows:    -   1: perform backup;
    -   0: only check, do not perform a backup.
|

3.  Execute the backup script.

**Create cloud tasks on Data**

**Importing full backup files**

1.  Log in to the RDS management console the RDS Management Console.
2.  Select the region where the target instance is located and click the ID of the target instance to enter the basic information page.
3.  Select Backup recovery from the left-hand menu bar.
4.  Upper right corner, click OSS backup data recovery cloud.
5.  If you're using OSS for the first time to back up data recovery on-cloud functionality, the RDS official service account needs to be granted access to OSS.
    1.  Click the authorized address in the third data import page of the Data Import wizard, as shown in the following figure:

        ![](images/4342_en-US.png)

    2.  Jump to the ram authorization page and click agree authorization to complete the authorization.

        ![](images/4343_en-US.png)

6.  After the authorization is complete, set the following parameters on the third step of the Data Import page of the Data Import wizard, click confirm to generate the cloud task on the OSS backup data.

    ![](images/4344_en-US.png)

    |Configuration items|Description|
    |-------------------|-----------|
    |Database name|The name of the target database on the target instance.|
    |OSS Bucket|Select the OSS bucket where the backup file is located.|
    |OSS subfolder name|The name of the subfolder in which the backup file is located.|
    |OSS file list|You can follow the fuzzy lookup of the backup file name prefix by clicking the right-hand glass button, displays the file name, file size, and update time. Please select a backup file that needs to be on the cloud.|
    |Cloud programme|     -   Open Database \(only one full backup file\): This option indicates that there is only one full backup file, please refer.
    -   Do not open the database \(with differential backup or log files\): This option applies to this scenario, indicates that the backup file contains full, differential, and log files.
 |
    |Consistency check method|     -   Asynchronous execution of DBCC: The system does not do DBCC when the database is opened Checkdb, which performs DBCC asynchronously after the Open Database task ends Checkdb operation to save time overhead of Opening Database Operations \(large database, DBCC\) Checkdb is very time consuming\), reducing the user's business downtime. If you are sensitive to business downtime requirements and don't care about DBCC Checkdb results, it is recommended that DBCC be executed asynchronously.
    -   Synchronous execution of DBCC: Compared to asynchronous execution of DBCC, some users are very concerned about DBCC Checkdb results to identify database data consistency errors under the user line. At this point, it is recommended that you choose to execute DBCC in sync, which affects how long it will take to open the database.
 |


**Import a differential or log backup file**

After the full backup file of the SQL Server local database is imported into the Previous cloud, you will need to import the differential backup or log backup files next, as follows:

1.  Log in to the RDS management console the RDS Management Console.
2.  Select the region where the target instance is located and click the ID of the target instance to enter the basic information page.
3.  Select Backup recovery from the left-hand menu bar.
4.  Upper right corner, click OSS backup data recovery cloud.

    Locate the record for the backup file to import in the task list, and Click Upload incremental file to the right of the record, opens the upload incremental files window, as shown in the following figure.

    ![](images/4345_en-US.png)

5.  Set the parameters, and click confirm to import the differences or log backup files.

    If you have multiple log backup files, use the same method to generate one-on-one cloud task.

    When uploading incremental files, try to ensure that the last backup file is not more than 500 mb in size, this reduces the time overhead of the incremental cloud. You can keep clicking the refresh button to view the latest status of cloud tasks on your data.

    **Note:** Before the last log backup file is generated, stop all writes to the local environment database, to ensure off-line database and RDS The database data on for SQL Server is consistent.


**To start a database online**

After importing a full backup file, an import difference, or a log backup file, the database will be in Recovery or restoring State. The most available version will be the in recovery state, and the stand-alone version will be the restoring State, the database cannot be read and write yet, and the database needs to be opened as follows:

1.  Log on to the RDS console.
2.  Select the region where the target instance is located and click the ID of the target instance to enter the basic information page.
3.  Select Backup recovery from the left-hand menu bar.
4.  Upper right corner, click OSS backup data recovery cloud.
5.  Locate the record for the backup file to import in the task list, and click Open Database to the right of the record, opens a database window.

    ![](images/4346_en-US.png)

6.  In the Open Database window, select how the database is opened. There are two ways to open a database consistency check:
    -   Asynchronous execution of DBCC: The system does not do DBCC checkdb when the database is opened, instead, after the Open Database task ends, the DBCC is executed asynchronously. Checkdb operation. Asynchronous DBCC mode saves time on Opening Database Operations \(large database, DBCC\) Checkdb is very time consuming\), reducing the user's business downtime. If you are sensitive to business downtime requirements and don't care about DBCC checkdb results, it is recommended that DBCC be executed asynchronously.

    -   Synchronous execution of DBCC: Compared to the asynchronous execution of DBCC, some users are very concerned about the results of DBCC checkdb, to find out the database data consistency error under the user line. At this point, it is recommended that you choose to execute DBCC in sync.


## View cloud records on backup { .section}

You can view cloud-on-backup records over a period of time, as follows:

Enter the Backup Recovery page and select cloud recovery records on the backup. By default, the most recent week of records is displayed. You can also modify the time range to view the upper cloud recovery records over a specific period of time.

![](images/4347_en-US.png)

## View cloud-on-the-cloud task backup file details {#section_xpq_hlw_ydb .section}

If you want to view the details of all the backup files for an on-site cloud task, follow these steps:

Go to the Backup Recovery page and select cloud recovery records on backup, click View File details on the far right side of the task to open the View File details page, displays details of all backup files associated with the corresponding task.

![](images/4348_en-US.png)

## Common Errors {#section_oqm_mlw_ydb .section}

Refer to the Common Errors section of the cloud on the full backup data. During incremental cloud on, the user may also encounter the following error.

**Database open failed**

Error message:

```
Failed to Open Database XXX.
```

Cause of error: offline SQL Some advanced features are enabled in the server database, migrate to the RDS for SQL Server after backing up the database with the cloud feature on the OSS, if the user chooses the RDS These advanced features are not supported by the SQL version, which causes the database to fail to open.

For example, the local SQL Server database is Enterprise Edition and data compression is enabled. Compression\) or partition, the OSS cloud to the RDS for SQL Server In the web version, this error is reported.

**You can reach this purpose in the following two ways:**

-   Disable the advanced features on the local instance of SQL Server, and then use the cloud features on OSS after the backup.

-   Purchase the same version of the RDS for SQL Server as the offline instance of SQL Server, for example, under SQL Server 2012 Enterprise Edition, purchase the RDS For SQL Server Enterprise stand-alone or high availability.


**The lsns in the Database Backup chain are not docking**

**Error message:**

```
The log in this backup set begins at lsn XXX, which is too recent to apply to the database.
        Restore log is determining normally.
```

Cause of error: in SQL In the server database, the premise that differential or log backups can be restored successfully is that, different or log-backed lsn must be able to connect to the last restored backup file, the lsn, otherwise, the error is reported. For a detailed theoretical basis, refer to database backup chain.

Workaround: select the corresponding lsn backup file for Incremental backup of the cloud on the file, A relatively simple way: Follow the backup file backup operation time to successfully incremental operation on the cloud.

**Asynchronous DBCC Checkdb success**

**Prompt information:**

```
Success to DBCC checkdb asynchronous.
```

Explanation: Due to DBCC Checkdb operations consume performance and time, so in order to increase the efficiency of the cloud on the user's database increment, we use Asynchronous tasks to do DBCC. Checkdb is the way to check the integrity of the cloud database on the user. When you see this prompt message, there is no consistency error in your cloud database. On the contrary, the following error is called "Asynchronous DBCC" Checkdb failed ".

**Asynchronous DBCC Checkdb failed**

**Error message:**

```
Asynchronous DBCC checkdb failed: checkdb found 0 allocation errors and 2 consistency
        Errors in Table 'xxx '(Object id xxx ).
```

Error reason: the user backup file was restored to the RDS For SQL Server, the cloud task system does DBCC Asynchronously Checkdb check, if the check does not pass, indicates that the user database has had an error in the local environment.

**You can reach this purpose in the following two ways:**

-   The user is in the RDS for SQL. Execution on server:

```
DBCC checkdb (dbname, FIG)
```

    **Note:** The process of fixing errors with this command may result in loss of user data.

-   To remove an RDS for SQL The corresponding database on the server, used online under:

```
DBCC checkdb (dbname,
      REPAIR_ALLOW_DATA_LOSS)
```

Fix database errors and re-perform the cloud on Database incremental steps.


**Full backup file type**

**Error message:**

```
Backup set (XXX) is a database full backup, we only accept transaction log or differential
        Backup.
```

Cause of error: cloud RDS on incremental For SQL After all the backup files have been restored during the server, you can only accept log backup files or differential backup files again. If the user chooses a full backup file again, the error is reported.

Workaround: select a log backup file or a differential backup file.

**Maximum number of databases limit**

**Error message:**

```
The database (XXX) Migration failed due to databases count limitation.
```

Cause of error: RDS For SQL Server 2012/2016 Dual Computer edition has 50 limits on the number of user databases, when the user database reaches 50 and then does the cloud operation again, the task fails to report this error. MySQL provides The number of databases in SQL Server 2012/2016 stand-alone is limited to 100, and the RDS for SQL Server This error will not be reported by 2008r2.

Workaround: migrate the cloud-on-the-go database to another RDS for SQL Server, or remove unnecessary databases.

Supplementary instructions: RDS SQL The reason why the 2012/2016 dual version limits the number of user databases is that when the user database is too large, could cause the RDS for SQL The server system itself occupies too many system processes in the background \(3 system processes per user database\). When the user database is too large, it will consume too much connection process, may cause the user's connection to fail to get the worker resource, which affects the RDS For SQL Server stability. Based on the principle that the user RDS for SQL Server is stable and efficient as the first priority, we're going to have an RDS for SQL Server. The number of user databases available in the 2012/2016 high edition is limited to 50.

